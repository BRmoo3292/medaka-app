<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ãƒ¡ãƒ€ã‚«ã®è¦³å¯Ÿã¨ä¼šè©±</title>
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      overflow-x: hidden;
    }
    
    .container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
    }
    
    h1 {
      font-size: 1.5rem;
      margin: 10px 0;
      text-align: center;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .video-section {
      width: 100%;
      max-width: 400px;
      margin-bottom: 10px;
    }
    
    #video {
      width: 100%;
      height: auto;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .canvas-container {
      position: relative;
      width: 100%;
      max-width: 400px;
      margin: 10px 0;
    }
    
    #displayCanvas {
      width: 100%;
      height: auto;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    
    #displayCanvas:active {
      transform: scale(0.98);
    }
    
    .canvas-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      border-radius: 12px;
    }
    
    .fullscreen-button {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 8px 12px;
      font-size: 12px;
      cursor: pointer;
      z-index: 10;
      backdrop-filter: blur(10px);
      transition: all 0.2s ease;
    }
    
    .fullscreen-button:hover {
      background: rgba(0,0,0,0.9);
      transform: scale(1.05);
    }
    
    /* ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .fullscreen-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: black;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    .fullscreen-canvas {
      max-width: 100vw;
      max-height: 80vh;
      object-fit: contain;
    }
    
    .fullscreen-controls {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 20px;
      z-index: 1001;
    }
    
    .control-button {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: none;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      backdrop-filter: blur(10px);
    }
    
    .record-button {
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      color: white;
    }
    
    .record-button.recording {
      background: linear-gradient(135deg, #ff3838, #c23616);
      animation: pulse 1.5s infinite;
    }
    
    .stop-button {
      background: linear-gradient(135deg, #555, #333);
      color: white;
    }
    
    .exit-button {
      background: linear-gradient(135deg, #2c2c54, #40407a);
      color: white;
      font-size: 18px;
    }
    
    .control-button:active {
      transform: scale(0.9);
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .status-section {
      width: 100%;
      max-width: 400px;
      text-align: center;
      margin: 15px 0;
    }
    
    #status {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 500;
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    #startButton {
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      color: white;
      border: none;
      border-radius: 25px;
      padding: 15px 30px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(79, 172, 254, 0.4);
      transition: all 0.3s ease;
      margin-top: 20px;
    }
    
    #startButton:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(79, 172, 254, 0.6);
    }
    
    #startButton:active {
      transform: translateY(0);
    }
    
    .normal-controls {
      display: flex;
      gap: 15px;
      margin-top: 15px;
    }
    
    .normal-control-button {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
    }
    
    .normal-record-button {
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      color: white;
    }
    
    .normal-record-button.recording {
      background: linear-gradient(135deg, #ff3838, #c23616);
      animation: pulse 1.5s infinite;
    }
    
    .normal-stop-button {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .hidden {
      display: none !important;
    }
    
    /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å‘ã‘ã®èª¿æ•´ */
    @media (max-width: 768px) {
      .container {
        padding: 5px;
      }
      
      h1 {
        font-size: 1.3rem;
        margin: 5px 0;
      }
      
      .video-section,
      .canvas-container,
      .status-section {
        max-width: 95vw;
      }
      
      .fullscreen-controls {
        bottom: 30px;
      }
      
      .control-button {
        width: 60px;
        height: 60px;
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ãƒ¡ãƒ€ã‚«ã«ãŠè©±ã—ã—ã¦ã­ï¼</h1>
    
    <div class="video-section">
      <video id="video" autoplay playsinline muted></video>
    </div>
    
    <div class="canvas-container" id="canvasContainer">
      <canvas id="displayCanvas"></canvas>
      <div class="canvas-overlay"></div>
      <button class="fullscreen-button" id="canvasFullscreenBtn">ğŸ” æ‹¡å¤§</button>
    </div>
    
    <div class="status-section">
      <div id="status">ğŸ¤ éŸ³å£°å…¥åŠ› å¾…æ©Ÿä¸­...</div>
      
      <div class="normal-controls" id="normalControls">
        <button class="normal-control-button normal-record-button" id="normalRecordBtn">ğŸ¤ éŒ²éŸ³</button>
        <button class="normal-control-button normal-stop-button" id="normalStopBtn">â¹ï¸ åœæ­¢</button>
      </div>
      
      <button id="startButton">ğŸš€ ä¼šè©±ã‚’å§‹ã‚ã‚‹</button>
    </div>
  </div>
  
  <!-- ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
  <div class="fullscreen-container hidden" id="fullscreenContainer">
    <canvas id="fullscreenCanvas"></canvas>
    <div class="fullscreen-controls">
      <button class="control-button record-button" id="recordBtn">ğŸ¤</button>
      <button class="control-button stop-button" id="stopBtn">â¹ï¸</button>
      <button class="control-button exit-button" id="exitBtn">âœ•</button>
    </div>
  </div>
  
  <audio id="replyAudio" autoplay></audio>
  <script>

// è¨­å®šãƒ»å®šæ•°
const CONFIG = {
    SERVER_URL: window.location.origin,
    FRAME_RATE: 33, // 15fps (1000ms / 30fps â‰ˆ 33ms)
    PROFILE_ID: 1 // ãƒ‡ãƒ¢ç”¨
};

// DOMè¦ç´ ã®å–å¾—
const elements = {
    // å‹•ç”»ãƒ»ã‚­ãƒ£ãƒ³ãƒã‚¹é–¢é€£
    video: document.getElementById('video'),
    displayCanvas: document.getElementById('displayCanvas'),
    fullscreenCanvas: document.getElementById('fullscreenCanvas'),
    
    // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    replyAudio: document.getElementById("replyAudio"),
    statusDiv: document.getElementById("status"),
    
    // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³é–¢é€£
    canvasFullscreenBtn: document.getElementById("canvasFullscreenBtn"),
    fullscreenContainer: document.getElementById("fullscreenContainer"),
    canvasContainer: document.getElementById("canvasContainer"),
    
    // ãƒœã‚¿ãƒ³é¡
    startButton: document.getElementById("startButton"),
    normalControls: document.getElementById("normalControls"),
    normalRecordBtn: document.getElementById("normalRecordBtn"),
    normalStopBtn: document.getElementById("normalStopBtn"),
    recordBtn: document.getElementById("recordBtn"),
    stopBtn: document.getElementById("stopBtn"),
    exitBtn: document.getElementById("exitBtn")
};

// ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å–å¾—
const displayCtx = elements.displayCanvas.getContext('2d');
const fullscreenCtx = elements.fullscreenCanvas.getContext('2d');

// ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ç®¡ç†
const appState = {
    isFullscreen: false,
    currentImageData: null,
    isRecording: false,
    shouldRestart: true,
    isSending: false,
    ws: null,
    wsConnected: false
};

// ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½
const cameraModule = {
    async startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { 
                    facingMode: "environment",
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            });
            elements.video.srcObject = stream;
        } catch (err) {
            elements.statusDiv.textContent = 'âš ï¸ ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ';
            console.error('Camera error:', err);
        }
    }
};

// WebSocketæ¥ç¶šæ©Ÿèƒ½
// WebSocketæ¥ç¶šæ©Ÿèƒ½
const websocketModule = {
    init() {
        this.connect();
    },

    connect() {
        const wsUrl = CONFIG.SERVER_URL.replace('https://', 'wss://').replace('http://', 'ws://') + '/ws';
        appState.ws = new WebSocket(wsUrl);
        
        appState.ws.onopen = () => {
            appState.wsConnected = true;
            console.log('WebSocketæ¥ç¶šå®Œäº†');
        };
        
        appState.ws.onmessage = (event) => {
            this.handleMessage(event);
        };
        
        appState.ws.onclose = () => {
            appState.wsConnected = false;
            console.log('WebSocketæ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚å†æ¥ç¶šã‚’è©¦è¡Œã—ã¾ã™...');
            setTimeout(() => this.connect(), 1000);
        };

        appState.ws.onerror = (error) => {
            console.error('WebSocket ã‚¨ãƒ©ãƒ¼:', error);
        };
    },

    handleMessage(event) {
        const resultImg = new Image();
        const imageUrl = URL.createObjectURL(event.data);
        
        resultImg.onload = () => {
            appState.currentImageData = resultImg;
            
            // imageModuleã®çµ±ä¸€ã•ã‚ŒãŸæç”»ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨
            imageModule.updateCanvases(resultImg);
            
            URL.revokeObjectURL(imageUrl);
            appState.isSending = false;
        };
        
        resultImg.src = imageUrl;
    },

    sendFrame() {
        if (!appState.ws || appState.ws.readyState !== WebSocket.OPEN) {
            return false;
        }

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = elements.video.videoWidth;
        canvas.height = elements.video.videoHeight;
        ctx.drawImage(elements.video, 0, 0);
        
        canvas.toBlob(blob => {
            if (appState.ws && appState.ws.readyState === WebSocket.OPEN) {
                appState.ws.send(blob);
            }
        }, 'image/jpeg', 0.8);

        return true;
    }
};

// ç”»åƒå‡¦ç†ãƒ»é€ä¿¡æ©Ÿèƒ½
const imageModule = {
    async sendFrame() {
        if (appState.isSending || !elements.video.videoWidth || !elements.video.videoHeight) return;
        
        appState.isSending = true;
        
        try {
            if (appState.wsConnected) {
                const success = websocketModule.sendFrame();
                if (success) return;
            }
            
            await this.sendFrameHTTP();
        } catch (error) {
            console.error("ç”»åƒé€ä¿¡ã‚¨ãƒ©ãƒ¼:", error);
            elements.statusDiv.textContent = 'âš ï¸ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        } finally {
            if (!appState.wsConnected) {
                appState.isSending = false;
            }
        }
    },

    async sendFrameHTTP() {
        const processedBlob = await this.captureAndProcessVideo();
        const resultBlob = await this.sendToServer(processedBlob);
        await this.displayResult(resultBlob);
    },

    async captureAndProcessVideo() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = elements.video.videoWidth;
        canvas.height = elements.video.videoHeight;
        ctx.drawImage(elements.video, 0, 0);
        
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.8));
        return blob;
    },

    async sendToServer(blob) {
        const formData = new FormData();
        formData.append('file', blob, 'capture.jpg');
        
        const response = await fetch(`${CONFIG.SERVER_URL}/predict`, {
            method: 'POST',
            body: formData,
        });
        
        if (!response.ok) throw new Error('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼');
        return await response.blob();
    },

    async displayResult(resultBlob) {
        const resultImg = new Image();
        const imageUrl = URL.createObjectURL(resultBlob);
        
        return new Promise((resolve) => {
            resultImg.onload = () => {
                appState.currentImageData = resultImg;
                this.updateCanvases(resultImg);
                URL.revokeObjectURL(imageUrl);
                resolve();
            };
            resultImg.src = imageUrl;
        });
    },

    // é€šå¸¸è¡¨ç¤ºã¨ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤ºã‚’çµ±ä¸€çš„ã«æ›´æ–°
    updateCanvases(resultImg) {
        // é€šå¸¸è¡¨ç¤ºã®æ›´æ–°
        elements.displayCanvas.width = resultImg.naturalWidth;
        elements.displayCanvas.height = resultImg.naturalHeight;
        displayCtx.imageSmoothingEnabled = true;
        displayCtx.imageSmoothingQuality = 'high';
        displayCtx.drawImage(resultImg, 0, 0);
        
        // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤ºä¸­ãªã‚‰åŒæœŸ
        if (appState.isFullscreen) {
            this.updateFullscreenCanvas(resultImg);
        }
    },

    updateFullscreenCanvas(resultImg) {
        if (!appState.isFullscreen) return;
        
        const screenWidth = window.innerWidth;
        const screenHeight = window.innerHeight;
        
        elements.fullscreenCanvas.width = screenWidth;
        elements.fullscreenCanvas.height = screenHeight;
        elements.fullscreenCanvas.style.width = `${screenWidth}px`;
        elements.fullscreenCanvas.style.height = `${screenHeight}px`;
        
        fullscreenCtx.imageSmoothingEnabled = true;
        fullscreenCtx.imageSmoothingQuality = 'high';
        
        const imageAspectRatio = resultImg.naturalWidth / resultImg.naturalHeight;
        const screenAspectRatio = screenWidth / screenHeight;
        
        let drawWidth, drawHeight, drawX, drawY;
        
        if (imageAspectRatio > screenAspectRatio) {
            drawWidth = screenWidth;
            drawHeight = screenWidth / imageAspectRatio;
            drawX = 0;
            drawY = (screenHeight - drawHeight) / 2;
        } else {
            drawWidth = screenHeight * imageAspectRatio;
            drawHeight = screenHeight;
            drawX = (screenWidth - drawWidth) / 2;
            drawY = 0;
        }
        
        fullscreenCtx.clearRect(0, 0, screenWidth, screenHeight);
        fullscreenCtx.drawImage(resultImg, drawX, drawY, drawWidth, drawHeight);
    },

    handleResize() {
        if (appState.currentImageData && appState.isFullscreen) {
            this.updateFullscreenCanvas(appState.currentImageData);
        }
    }
};

window.addEventListener('resize', () => {
    imageModule.handleResize();
});

// ã‚ªãƒªã‚¨ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å¤‰æ›´æ™‚ã®å‡¦ç†ï¼ˆãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼‰
window.addEventListener('orientationchange', () => {
    setTimeout(() => {
        imageModule.handleResize();
    }, 500); // ã‚ªãƒªã‚¨ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å¤‰æ›´å¾Œã«å°‘ã—å¾…ã¤
});

// éŸ³å£°èªè­˜æ©Ÿèƒ½
const speechModule = {
    recognition: null,

    init() {
        this.recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        this.recognition.lang = "ja-JP";
        this.recognition.interimResults = false;
        this.recognition.continuous = false;
        
        this.setupEventListeners();
    },

    setupEventListeners() {
        this.recognition.onstart = () => {
            elements.statusDiv.textContent = "ğŸ¤ èã„ã¦ã„ã¾ã™...";
            appState.isRecording = true;
            this.updateRecordingUI(true);
        };

        this.recognition.onresult = async (event) => {
            appState.shouldRestart = true;
            appState.isRecording = false;
            this.updateRecordingUI(false);
            
            const transcript = event.results[0][0].transcript;
            elements.statusDiv.textContent = `ğŸ—£ï¸ ã‚ãªãŸ: ${transcript}`;
            
            await this.sendTextToServer(transcript);
        };

        this.recognition.onerror = (event) => {
            appState.isRecording = false;
            this.updateRecordingUI(false);
            elements.statusDiv.textContent = "ğŸŸ ãƒ¡ãƒ€ã‚«ã«ãŠè©±ã—ã—ã¦ã­ï¼";
            appState.shouldRestart = true;
            
            // ã‚¨ãƒ©ãƒ¼å¾Œã€è‡ªå‹•ã§éŒ²éŸ³ã‚’å†é–‹ï¼ˆ3ç§’å¾Œï¼‰
            setTimeout(() => {
                if (appState.shouldRestart && !appState.isRecording) {
                    console.log("[éŸ³å£°ã‚¨ãƒ©ãƒ¼] è‡ªå‹•éŒ²éŸ³å†é–‹");
                    this.startDirectRecording();
                }
            }, 3000);
        };

        this.recognition.onend = () => {
            appState.isRecording = false;
            this.updateRecordingUI(false);
            if (!appState.shouldRestart) {
                elements.statusDiv.textContent = "ğŸ¤ éŸ³å£°å…¥åŠ› å¾…æ©Ÿä¸­...";
            }
        };
    },

    async sendTextToServer(transcript) {
        try {
            const response = await fetch(`${CONFIG.SERVER_URL}/talk_with_fish_text`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    user_input: transcript,
                    profile_id: CONFIG.PROFILE_ID
                })
            });
            
            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            elements.replyAudio.src = audioUrl;
            elements.replyAudio.play();
            
            elements.replyAudio.onended = () => {
                elements.statusDiv.textContent = "ğŸ¤ éŸ³å£°å…¥åŠ› å¾…æ©Ÿä¸­...";
                setTimeout(() => {
                    if (appState.shouldRestart && !appState.isRecording) {
                        // è‡ªå‹•å†é–‹ã¯ã›ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œã‚’å¾…ã¤
                    }
                }, 1000);
            };
        } catch (error) {
            console.error("éŸ³å£°é€ä¿¡ã‚¨ãƒ©ãƒ¼:", error);
            elements.statusDiv.textContent = 'âš ï¸ éŸ³å£°å‡¦ç†ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        }
    },

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦éŒ²éŸ³é–‹å§‹ã®å‡¦ç†ã‚’åˆ†å²
    async startRecording() {
        if (!appState.isRecording && appState.shouldRestart) {
            try {
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª
                const sessionResponse = await fetch(`${CONFIG.SERVER_URL}/check_session_status`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ profile_id: CONFIG.PROFILE_ID })
                });
                
                const sessionData = await sessionResponse.json();
                
                if (sessionData.has_active_session) {
                    // 2å›ç›®ã®ä¼šè©±ãƒ•ãƒ­ãƒ¼ - ç›´æ¥éŒ²éŸ³é–‹å§‹
                    console.log("[éŒ²éŸ³] 2å›ç›®ãƒ•ãƒ­ãƒ¼ - ç›´æ¥éŒ²éŸ³é–‹å§‹");
                    this.startDirectRecording();
                } else if (sessionData.proactive_enabled) {
                    // 1å›ç›®ã®ä¼šè©±ãƒ•ãƒ­ãƒ¼ - ãƒ—ãƒ­ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ©Ÿèƒ½ãŒæœ‰åŠ¹ãªå ´åˆã®ã¿ãƒ¡ãƒ€ã‚«ã‹ã‚‰è©±ã—ã‹ã‘
                    console.log("[éŒ²éŸ³] 1å›ç›®ãƒ•ãƒ­ãƒ¼ - ãƒ¡ãƒ€ã‚«ã‹ã‚‰è©±ã—ã‹ã‘ï¼ˆãƒ—ãƒ­ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æœ‰åŠ¹ï¼‰");
                    await this.startWithMedakaGreeting();
                } else {
                    // ãƒ—ãƒ­ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ©Ÿèƒ½ãŒç„¡åŠ¹ - ç›´æ¥éŒ²éŸ³é–‹å§‹
                    console.log("[éŒ²éŸ³] 1å›ç›®ãƒ•ãƒ­ãƒ¼ - ç›´æ¥éŒ²éŸ³é–‹å§‹ï¼ˆãƒ—ãƒ­ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ç„¡åŠ¹ï¼‰");
                    this.startDirectRecording();
                }
            } catch (error) {
                console.error("ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼:", error);
                // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ç›´æ¥éŒ²éŸ³é–‹å§‹
                this.startDirectRecording();
            }
        }
    },

    // ç›´æ¥éŒ²éŸ³ã‚’é–‹å§‹
    startDirectRecording() {
        if (!appState.isRecording && appState.shouldRestart) {
            try {
                appState.isRecording = true;
                this.recognition.start();
                this.updateRecordingUI(true);
            } catch (error) {
                console.error("éŒ²éŸ³é–‹å§‹ã‚¨ãƒ©ãƒ¼:", error);
                appState.isRecording = false;
                this.updateRecordingUI(false);
                elements.statusDiv.textContent = "ğŸŸ ãƒ¡ãƒ€ã‚«ã«ãŠè©±ã—ã—ã¦ã­ï¼";
                
                // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã‚‚å†è©¦è¡Œ
                setTimeout(() => {
                    if (appState.shouldRestart && !appState.isRecording) {
                        this.startDirectRecording();
                    }
                }, 3000);
            }
        }
    },

    // ãƒ¡ãƒ€ã‚«ã®æŒ¨æ‹¶ã‹ã‚‰å§‹ã‚ã‚‹éŒ²éŸ³
    async startWithMedakaGreeting() {
        try {
            elements.statusDiv.textContent = "ğŸŸ ãƒ¡ãƒ€ã‚«ãŒè©±ã—ã‹ã‘ã¦ã„ã¾ã™...";
            
            // ãƒ¡ãƒ€ã‚«ã‹ã‚‰ã®æŒ¨æ‹¶ã‚’å–å¾—
            const greetingResponse = await fetch(`${CONFIG.SERVER_URL}/get_proactive_message`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ profile_id: CONFIG.PROFILE_ID })
            });
            
            const greetingBlob = await greetingResponse.blob();
            const greetingUrl = URL.createObjectURL(greetingBlob);
            elements.replyAudio.src = greetingUrl;
            
            await elements.replyAudio.play();
            
            // ãƒ¡ãƒ€ã‚«ã®ç™ºè©±ãŒçµ‚ã‚ã£ãŸã‚‰éŒ²éŸ³é–‹å§‹
            elements.replyAudio.onended = () => {
                elements.statusDiv.textContent = "ğŸ¤ ãƒ¡ãƒ€ã‚«ãŒè©±ã—ã‹ã‘ãŸã‚ˆã€‚ãŠè¿”äº‹ã—ã¦ã­ï¼";
                setTimeout(() => {
                    this.startDirectRecording();
                }, 1000);
            };
            
        } catch (error) {
            console.error("ãƒ¡ãƒ€ã‚«æŒ¨æ‹¶ã‚¨ãƒ©ãƒ¼:", error);
            // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ç›´æ¥éŒ²éŸ³é–‹å§‹
            this.startDirectRecording();
        }
    },

    stopRecording() {
        if (appState.isRecording) {
            appState.isRecording = false;
            appState.shouldRestart = false;
            this.recognition.stop();
            this.updateRecordingUI(false);
        }
    },

    updateRecordingUI(recording) {
        const buttons = [elements.normalRecordBtn, elements.recordBtn];
        buttons.forEach(btn => {
            if (recording) {
                btn.classList.add('recording');
            } else {
                btn.classList.remove('recording');
            }
        });
    }
};

// ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³æ©Ÿèƒ½
const fullscreenModule = {
    enterFullscreen() {
        appState.isFullscreen = true;
        elements.fullscreenContainer.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        elements.canvasFullscreenBtn.textContent = 'ğŸ“± æˆ»ã‚‹';
        
        // ç¾åœ¨ã®ç”»åƒã‚’ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹ã«ã‚³ãƒ”ãƒ¼
        if (appState.currentImageData) {
            this.updateFullscreenCanvas(appState.currentImageData);
        }
    },

    exitFullscreen() {
        appState.isFullscreen = false;
        elements.fullscreenContainer.classList.add('hidden');
        document.body.style.overflow = 'auto';
        elements.canvasFullscreenBtn.textContent = 'ğŸ” æ‹¡å¤§';
    },

    updateFullscreenCanvas(resultImg) {
        if (!appState.isFullscreen) return;
        
        // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³æ™‚ã¯ç”»é¢å…¨ä½“ã«åˆã‚ã›ã‚‹
        const screenWidth = window.innerWidth;
        const screenHeight = window.innerHeight;
        
        elements.fullscreenCanvas.width = screenWidth;
        elements.fullscreenCanvas.height = screenHeight;
        elements.fullscreenCanvas.style.width = `${screenWidth}px`;
        elements.fullscreenCanvas.style.height = `${screenHeight}px`;
        
        // é«˜å“è³ªãªæç”»è¨­å®š
        fullscreenCtx.imageSmoothingEnabled = true;
        fullscreenCtx.imageSmoothingQuality = 'high';
        
        // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ã¦ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°
        const imageAspectRatio = resultImg.naturalWidth / resultImg.naturalHeight;
        const screenAspectRatio = screenWidth / screenHeight;
        
        let drawWidth, drawHeight, drawX, drawY;
        
        if (imageAspectRatio > screenAspectRatio) {
            // ç”»åƒãŒæ¨ªé•·ï¼šå¹…ã‚’ç”»é¢ã«åˆã‚ã›ã‚‹
            drawWidth = screenWidth;
            drawHeight = screenWidth / imageAspectRatio;
            drawX = 0;
            drawY = (screenHeight - drawHeight) / 2;
        } else {
            // ç”»åƒãŒç¸¦é•·ï¼šé«˜ã•ã‚’ç”»é¢ã«åˆã‚ã›ã‚‹
            drawWidth = screenHeight * imageAspectRatio;
            drawHeight = screenHeight;
            drawX = (screenWidth - drawWidth) / 2;
            drawY = 0;
        }
        
        fullscreenCtx.clearRect(0, 0, screenWidth, screenHeight);
        fullscreenCtx.drawImage(resultImg, drawX, drawY, drawWidth, drawHeight);
    },

    setupEventListeners() {
        elements.canvasFullscreenBtn.addEventListener('click', () => {
            if (appState.isFullscreen) {
                this.exitFullscreen();
            } else {
                this.enterFullscreen();
            }
        });

        elements.displayCanvas.addEventListener('click', () => {
            if (!appState.isFullscreen) {
                this.enterFullscreen();
            }
        });

        elements.exitBtn.addEventListener('click', () => this.exitFullscreen());
    }
};

// UIåˆ¶å¾¡æ©Ÿèƒ½
const uiModule = {
    setupRecordingButtons() {
        // éŒ²éŸ³é–‹å§‹ãƒœã‚¿ãƒ³
        [elements.normalRecordBtn, elements.recordBtn].forEach(btn => {
            btn.addEventListener('click', () => speechModule.startRecording());
        });
        // éŒ²éŸ³åœæ­¢ãƒœã‚¿ãƒ³
        [elements.normalStopBtn, elements.stopBtn].forEach(btn => {
            btn.addEventListener('click', () => speechModule.stopRecording());
        });
    },
    
    setupStartButton() {
        elements.startButton.addEventListener("click", () => {
            elements.replyAudio.src = "";
            elements.replyAudio.load();
            setTimeout(() => {
                appState.shouldRestart = true;
                elements.startButton.classList.add('hidden');
                elements.normalControls.classList.remove('hidden');
                elements.statusDiv.textContent = "ğŸ¤ éŒ²éŸ³ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è©±ã—ã‹ã‘ã¦ãã ã•ã„";
            }, 500);
        });
    }
};

// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–ãƒ»ãƒ¡ã‚¤ãƒ³å‡¦ç†
const app = {
    async init() {
        // åˆæœŸUIçŠ¶æ…‹ã®è¨­å®š
        elements.normalControls.classList.add('hidden');
        
        // å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®åˆæœŸåŒ–
        await cameraModule.startCamera();
        websocketModule.init(); // WebSocketæ¥ç¶šã‚’åˆæœŸåŒ–
        speechModule.init();
        fullscreenModule.setupEventListeners();
        uiModule.setupRecordingButtons();
        uiModule.setupStartButton();
        
        // ãƒ•ãƒ¬ãƒ¼ãƒ é€ä¿¡ã®å®šæœŸå®Ÿè¡Œ
        setInterval(() => imageModule.sendFrame(), CONFIG.FRAME_RATE);
        
        // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®æœ€é©åŒ–
        this.optimizeTouchEvents();
        
        console.log('ğŸ  é­šèªè­˜ã‚¢ãƒ—ãƒªãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸï¼ˆåœ§ç¸®ãƒ»è§£åƒåº¦å›ºå®šãªã—ï¼‰');
    },

    optimizeTouchEvents() {
        document.addEventListener('touchstart', function(){}, {passive: true});
        document.addEventListener('touchmove', function(){}, {passive: true});
    }
};

// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
app.init();
  </script>
</body>
</html>